# Long Life - Technical Architecture & Best Practices

**Last Updated**: 2025-11-17
**Project**: DrinkLongLife E-commerce Platform

---

## ğŸ—ï¸ Current Architecture Overview

### Data Layer: HYBRID (Sanity + Supabase)

The site currently uses **TWO** content management systems with **CLEAR** separation of concerns:

#### âœ… Supabase (PRIMARY - Products & E-commerce)
**Owner**: Product catalog, variants, pricing, inventory, orders, subscriptions, users

**What Lives in Supabase**:
- **Products** (`products` table) - Blend information, images, descriptions
- **Product Variants** (`product_variants` table) - Sizes, prices, Stripe price IDs
- **Product Ingredients** (`product_ingredients` table) - Ingredient associations
- **Ingredients** (`ingredients` table) - Individual ingredient data
- **Orders** (`orders` table) - Customer orders
- **Subscriptions** (`subscriptions` table) - Recurring orders
- **Users** (`profiles` table) - Customer accounts
- **Referrals** (`referrals` table) - Referral tracking

**Query Location**: `lib/supabase/queries/products.ts`

**Key Functions**:
- `getAllProducts()` - Get all products
- `getFeaturedProducts()` - Get featured products (for homepage)
- `getProductBySlug(slug)` - Get single product by slug
- `getAllProductsForStaticGen()` - Get products for static generation

**Used By**:
- âœ… `/` (Homepage) - Featured products
- âœ… `/blends` (Products listing page)
- âœ… `/blends/[slug]` (Individual product pages)
- âœ… `/pricing` (Pricing page)
- âœ… `/sitemap.ts` (SEO sitemap)
- âœ… Cart, Checkout, Stripe integration

---

#### âœ… Sanity CMS (SECONDARY - Content Pages)
**Owner**: Marketing pages, blog, FAQs, about content

**What Lives in Sanity**:
- **Content Pages** - FAQ, How We Make It, Ingredients & Sourcing, About
- **Blog Posts** (`post` schema) - Journal articles
- **Homepage Content** (`homePage` schema) - Hero, sections, CTAs
- **Navigation** (`navigation` schema) - Site navigation structure
- **Site Settings** (`siteSettings` schema) - Global config
- **Stripe Settings** (`stripeSettings` schema) - Stripe mode config (test/production)

**Query Location**: `lib/sanity.queries.ts`

**Used By**:
- âœ… `/faq` - FAQ page content
- âœ… `/how-we-make-it` - Process page content
- âœ… `/ingredients` - Ingredients & sourcing page content
- âœ… `/about` - About page content
- âœ… `/journal` - Blog listing
- âœ… `/journal/[slug]` - Individual blog posts
- âœ… `/(website)/layout.tsx` - Navigation and site settings
- âœ… `/admin/stripe` - Stripe settings UI

---

## âŒ REDUNDANCIES & DEPRECATED

### âœ… CLEANUP COMPLETED: Removed Deprecated Schemas

**The following Sanity schemas have been DELETED** (as of 2025-11-17):
- âŒ `blend.ts` - Deleted (products now in Supabase)
- âŒ `ingredient.ts` - Deleted (ingredients now in Supabase)
- âŒ `farm.ts` - Deleted (not used)
- âŒ `sizePrice.ts` - Deleted (pricing now in Supabase)

**Cleaned up**:
- âœ… Removed `featuredBlends` reference from `homePageQuery` in `lib/sanity.queries.ts`
- âœ… Homepage now uses `getFeaturedProducts()` from Supabase
- âœ… All product-related queries removed from Sanity

**Kept**:
- âœ… `blendsPage.ts` - Page metadata (heading, subheading, SEO) - NOT product data
  - Currently unused (page has hardcoded settings)
  - Can be connected later if CMS control over page text is desired

**Status**: CLEAN - No more deprecated product code in Sanity

---

## ğŸ“‹ Best Practices & Rules

### Rule 1: Know Your Data Source

**Products & E-commerce â†’ Supabase**
```typescript
// âœ… CORRECT
import { getAllProducts } from '@/lib/supabase/queries/products';
const products = await getAllProducts();
```

**Content Pages â†’ Sanity**
```typescript
// âœ… CORRECT
import { client } from '@/lib/sanity.client';
import { faqQuery } from '@/lib/sanity.queries';
const faqs = await client.fetch(faqQuery);
```

---

### Rule 2: Never Mix Product Data Sources

**âŒ WRONG** - Don't fetch products from Sanity:
```typescript
// DON'T DO THIS
import { blendsQuery } from '@/lib/sanity.queries';
const blends = await client.fetch(blendsQuery); // DEPRECATED
```

**âœ… CORRECT** - Always use Supabase for products:
```typescript
import { getAllProducts } from '@/lib/supabase/queries/products';
const products = await getAllProducts();
```

---

### Rule 3: Logging Best Practices

**âŒ WRONG** - Don't use console.log in production code:
```typescript
console.log('Debug info:', data);
console.error('Error:', error);
```

**âœ… CORRECT** - Use logger utility:
```typescript
import { logger } from '@/lib/logger';
logger.debug('Debug info:', data);  // Only shows in development
logger.error('Error:', error);       // Only shows in development
```

---

### Rule 4: TypeScript Strictness

**Always provide types** - No implicit `any`:
```typescript
// âŒ WRONG
let products = [];

// âœ… CORRECT
let products: any[] = [];

// âœ… BETTER
let products: Product[] = [];
```

---

## ğŸ—‚ï¸ Directory Structure

```
/app
  /(website)
    /blends              â†’ Supabase products
    /blends/[slug]       â†’ Supabase products
    /faq                 â†’ Sanity content
    /how-we-make-it      â†’ Sanity content
    /ingredients         â†’ Sanity content
    /journal             â†’ Sanity posts
    /journal/[slug]      â†’ Sanity posts
    page.tsx             â†’ Sanity homepage + Supabase featured products (HYBRID)
  /api
    /checkout            â†’ Stripe + Supabase
    /stripe/webhook      â†’ Stripe + Supabase
  sitemap.ts             â†’ Supabase products
  robots.ts              â†’ Static

/lib
  /supabase
    /queries
      products.ts        â†’ Product queries (PRIMARY)
  sanity.client.ts       â†’ Sanity client
  sanity.queries.ts      â†’ Content queries (SECONDARY)
  logger.ts              â†’ Logging utility

/sanity
  /schemas
    âœ… ACTIVE:
      - homePage.ts
      - faqPage.ts
      - blendsPage.ts (page metadata only, not products)
      - processPage.ts (how-we-make-it)
      - ingredientsSourcingPage.ts
      - post.ts (blog)
      - navigation.ts
      - siteSettings.ts
      - stripeSettings.ts
      - All other page/content schemas
```

---

## ğŸ”„ Migration Status

### âœ… Completed Migrations

1. **Homepage Products** - Now uses `getFeaturedProducts()` from Supabase
2. **Blends Listing Page** - Now uses `getAllProducts()` from Supabase
3. **Individual Blend Pages** - Now uses `getProductBySlug()` from Supabase
4. **Sitemap** - Now uses `getAllProducts()` from Supabase
5. **Pricing Page** - Now uses `getAllProducts()` from Supabase

### ğŸš§ Partial Migrations (HYBRID)

1. **Homepage** - Uses Sanity for page content + Supabase for featured products
2. **Website Layout** - Uses Sanity for navigation + site settings

### â“ Unclear/To Investigate

1. `/app/(website)/[slug]/page.tsx` - Dynamic page router, may pull from Sanity
2. `/app/(website)/subscriptions/page.tsx` - Unclear if uses Sanity or static
3. `/app/(website)/account/perks/page.tsx` - Unclear if uses Sanity

---

## ğŸ¯ Stripe Integration

**Location**: Supabase ONLY

- Product sync: `lib/stripe/product-sync.ts`
- Checkout: `/api/checkout/route.ts`
- Webhook: `/api/stripe/webhook/route.ts`
- Price IDs stored in: `product_variants.stripe_price_id`

**Stripe Mode** (test/production) is configured in:
- Sanity: `stripeSettings` document
- Environment: `STRIPE_SECRET_KEY`

---

## ğŸ“§ Email Integration

**Status**: Partially implemented

**Provider**: Resend

**Templates Location**: `lib/email/templates/`
- `newsletter-welcome.tsx` - Newsletter signup confirmation
- `order-confirmation.tsx` - Order confirmation
- `contact-form.tsx` - Wholesale inquiry notification

**Integration Points**:
- `lib/actions.ts` - Newsletter & wholesale forms (âœ… Connected)
- `lib/email/send.ts` - Order confirmations (âœ… Connected to webhook)
- `/api/stripe/webhook/route.ts` - Sends order emails (âœ… Connected)

**Environment Variables Needed**:
- `RESEND_API_KEY` - Resend API key
- `EMAIL_FROM` - Sender email address

---

## ğŸ§ª Testing

**E2E Tests**: Playwright (`/tests/e2e/`)

**Test Data Sources**:
- Products: Uses Supabase (production database)
- Checkout: Uses Stripe test mode
- Content: Uses Sanity (may be mixed)

---

## ğŸš€ Deployment Checklist

Before deploying to production:

1. âœ… Verify `NEXT_PUBLIC_SITE_URL` is set correctly
2. âœ… Ensure Supabase has all products configured
3. âœ… Verify Stripe webhook is pointing to production URL
4. âœ… Set `RESEND_API_KEY` for email notifications
5. âœ… Verify `EMAIL_FROM` domain in Resend
6. âš ï¸ Consider deprecating/removing old Sanity product schemas
7. âš ï¸ Run `npm run build` to verify 0 TypeScript errors

---

## ğŸ” Common Issues & Solutions

### Issue: "Product not found"
**Check**: Is product in Supabase `products` table?
**Fix**: Create product in Supabase, not Sanity

### Issue: "Page content not loading"
**Check**: Is it a content page (FAQ, About, etc.)?
**Fix**: Ensure Sanity CMS has the content document

### Issue: "Console logs in production"
**Check**: Are you using `console.log` directly?
**Fix**: Replace with `logger.debug()` from `lib/logger.ts`

### Issue: "TypeScript errors on build"
**Check**: Run `npx tsc --noEmit` to see all errors
**Fix**: Add proper type annotations, remove unused imports

---

## ğŸ“š Quick Reference

### Get Products (Supabase)
```typescript
import { getAllProducts, getFeaturedProducts, getProductBySlug } from '@/lib/supabase/queries/products';
```

### Get Content (Sanity)
```typescript
import { client } from '@/lib/sanity.client';
import { faqQuery, processPageQuery } from '@/lib/sanity.queries';
```

### Logging
```typescript
import { logger } from '@/lib/logger';
logger.debug('Development only');
logger.error('Error occurred');
```

---

## âš ï¸ DO NOT

1. âŒ Create products in Sanity CMS (those schemas have been deleted)
2. âŒ Use `console.log` in production code
3. âŒ Skip TypeScript types (`any` everywhere)
4. âŒ Mix Sanity and Supabase for the same data type

---

## âœ… DO

1. âœ… Create products in Supabase database
2. âœ… Use `getAllProducts()` for product lists
3. âœ… Use Sanity ONLY for content pages (FAQ, About, Blog)
4. âœ… Use `logger` utility for all logging
5. âœ… Add proper TypeScript types
6. âœ… Run `npm run build` before committing
7. âœ… Update this document when architecture changes

---

**Questions or unclear architecture decisions? Update this document!**
